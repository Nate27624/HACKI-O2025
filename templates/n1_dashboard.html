<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEP Grid Challenge - N-1 Contingency Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tahoma', 'MS Sans Serif', sans-serif;
            background: linear-gradient(to bottom, #0054e3 0%, #0054e3 3px, #4b91d9 3px, #207dca 98%, #1941a5 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #000;
        }
        
        .header {
            background: linear-gradient(to bottom, #245edb 0%, #1941a5 50%, #0d2a85 51%, #002266 100%);
            border-bottom: 1px solid #0d2a85;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 1px 3px rgba(0,0,0,0.3);
        }

        .header .site-title {
            font-size: 16px;
            color: #ffffff;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            font-family: 'Tahoma', sans-serif;
        }

        .header .site-desc {
            font-size: 11px;
            color: #b8d4f0;
            margin-top: 2px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
        }

        .site-nav a {
            color: #ffffff;
            text-decoration: none;
            margin-left: 8px;
            padding: 4px 12px;
            border-radius: 3px;
            font-weight: normal;
            font-size: 11px;
            background: linear-gradient(to bottom, #4b91d9 0%, #207dca 50%, #1941a5 51%, #002266 100%);
            border: 1px solid #0d2a85;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }

        .site-nav a:hover {
            background: linear-gradient(to bottom, #5ba0e8 0%, #3087d9 50%, #2850b4 51%, #113375 100%);
        }

        .site-nav a.active {
            background: linear-gradient(to bottom, #1941a5 0%, #0d2a85 50%, #002266 51%, #001144 100%);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
        }

        @media (max-width: 720px) {
            .header { flex-direction: column; align-items: flex-start; }
            .site-nav { margin-top: 8px; }
        }
        
        .nav-links {
            margin-top: 15px;
        }
        
        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .nav-links a:hover {
            background-color: #f0f0f0;
        }
        
        .nav-links a.active {
            background-color: #667eea;
            color: white;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 12px;
        }
        
        .controls {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            padding: 12px;
            border: 2px outset #ece9d8;
            margin-bottom: 8px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            font-family: 'Tahoma', sans-serif;
        }
        
        .control-group {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .control-item label {
            font-weight: normal;
            color: #000;
            font-size: 11px;
            font-family: 'Tahoma', sans-serif;
        }
        
        .control-item input, .control-item select {
            padding: 3px 4px;
            border: 2px inset #ece9d8;
            background: #ffffff;
            font-family: 'Tahoma', sans-serif;
            font-size: 11px;
            width: 80px;
        }
        
        .analyze-btn {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            color: #000;
            border: 2px outset #ece9d8;
            padding: 4px 12px;
            font-size: 11px;
            font-weight: normal;
            cursor: pointer;
            font-family: 'Tahoma', sans-serif;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .analyze-btn:hover {
            background: linear-gradient(to bottom, #f2efde 0%, #ece8d9 50%, #ddd9ca 51%, #d1cdbf 100%);
        }
        
        .analyze-btn:active {
            border: 2px inset #ece9d8;
            background: linear-gradient(to bottom, #d8d4c5 0%, #ccc8b9 50%, #c0bca8 51%, #b4b09c 100%);
        }

        #aiSummaryBtnN1 {
            background: linear-gradient(to bottom, #e8f5e8 0%, #d4f0d4 50%, #c0e8c0 51%, #a8d8a8 100%);
            border-color: #4caf50;
        }

        #aiSummaryBtnN1:hover {
            background: linear-gradient(to bottom, #f0f8f0 0%, #dcf2dc 50%, #c8ecc8 51%, #b0dcb0 100%);
        }

        .ai-summary-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        .ai-summary-content h4 {
            color: #2c3e50;
            margin: 15px 0 8px 0;
            font-size: 16px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 4px;
        }

        .ai-summary-content h4:first-child {
            margin-top: 0;
        }

        .ai-summary-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .ai-summary-content li {
            margin: 4px 0;
        }

        .ai-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .ai-loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-top: 2px solid #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .card {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            padding: 12px;
            border: 2px outset #ece9d8;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            font-family: 'Tahoma', sans-serif;
            margin-bottom: 8px;
        }
        
        .card h3 {
            color: #000;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: bold;
            font-family: 'Tahoma', sans-serif;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .summary-item {
            text-align: center;
            padding: 8px;
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            border: 2px outset #ece9d8;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .summary-item.critical {
            background: linear-gradient(to bottom, #ffcccc 0%, #ffaaaa 50%, #ff8888 51%, #ff6666 100%);
            color: #800000;
            border: 1px inset #ffcccc;
        }
        
        .summary-item.normal {
            background: linear-gradient(to bottom, #ccffcc 0%, #99ff99 50%, #66ff66 51%, #33ff33 100%);
            color: #006600;
            border: 1px inset #ccffcc;
        }
        
        .summary-item .number {
            font-size: 14px;
            font-weight: bold;
            display: block;
            font-family: 'Tahoma', sans-serif;
        }
        
        .summary-item .label {
            font-size: 10px;
            text-transform: uppercase;
            margin-top: 2px;
            font-family: 'Tahoma', sans-serif;
        }
        
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px inset #ece9d8;
            background: #ffffff;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Tahoma', sans-serif;
        }
        
        th, td {
            padding: 4px 6px;
            text-align: left;
            border-bottom: 1px solid #c0c0c0;
            font-size: 11px;
        }
        
        th {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            font-weight: bold;
            position: sticky;
            top: 0;
            border: 1px outset #ece9d8;
        }
        
        .status-badge {
            padding: 2px 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            border: 1px outset;
            font-family: 'Tahoma', sans-serif;
        }
        
        .status-overloaded {
            background: linear-gradient(to bottom, #ff9999 0%, #ff6666 100%);
            color: #660000;
            border-color: #ff9999;
            font-weight: bold;
        }
        
        .status-critical {
            background: linear-gradient(to bottom, #ffcccc 0%, #ff9999 100%);
            color: #800000;
            border-color: #ffcccc;
        }
        
        .status-caution {
            background: linear-gradient(to bottom, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-color: #fff3cd;
        }
        
        .status-normal {
            background: linear-gradient(to bottom, #ccffcc 0%, #99ff99 100%);
            color: #006600;
            border-color: #ccffcc;
        }
        
        .status-error {
            background: linear-gradient(to bottom, #ffcccc 0%, #ff9999 100%);
            color: #800000;
            border-color: #ffcccc;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            background: #ffffff;
            border: 2px inset #ece9d8;
            padding: 4px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px inset #ece9d8;
            margin-bottom: 8px;
        }
        
        .tab {
            padding: 4px 12px;
            cursor: pointer;
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            border: 2px outset #ece9d8;
            font-family: 'Tahoma', sans-serif;
            font-size: 11px;
            margin-right: 2px;
        }
        
        .tab.active {
            background: linear-gradient(to bottom, #d8d4c5 0%, #ccc8b9 50%, #c0bca8 51%, #b4b09c 100%);
            border: 2px inset #ece9d8;
            color: #000;
            font-weight: bold;
        }
        
        .tab:hover:not(.active) {
            background: linear-gradient(to bottom, #f2efde 0%, #ece8d9 50%, #ddd9ca 51%, #d1cdbf 100%);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .filter-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .filter-item label {
            font-size: 10px;
            font-weight: normal;
            color: #000;
            font-family: 'Tahoma', sans-serif;
        }
        
        .filter-item input, .filter-item select {
            padding: 2px 4px;
            border: 2px inset #ece9d8;
            background: #ffffff;
            font-size: 11px;
            width: 80px;
            font-family: 'Tahoma', sans-serif;
        }
        
        .export-btn {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            color: #000;
            border: 2px outset #ece9d8;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 10px;
            margin-left: auto;
            font-family: 'Tahoma', sans-serif;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .export-btn:hover {
            background: linear-gradient(to bottom, #f2efde 0%, #ece8d9 50%, #ddd9ca 51%, #d1cdbf 100%);
        }
        
        .export-btn:active {
            border: 2px inset #ece9d8;
            background: linear-gradient(to bottom, #d8d4c5 0%, #ccc8b9 50%, #c0bca8 51%, #b4b09c 100%);
        }
        
        .severity-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .severity-overloaded {
            background: #d32f2f;
        }
        
        .severity-critical {
            background: #f44336;
        }
        
        .severity-caution {
            background: #ff9800;
        }
        
        .severity-normal {
            background: #4caf50;
        }
        
        .details-row {
            background: #f8f9fa;
            display: none;
        }
        
        .details-content {
            padding: 15px;
            border-left: 4px solid #667eea;
        }
        
        .expandable-row {
            cursor: pointer;
        }
        
        .expandable-row:hover {
            background: #f5f5f5;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            padding: 8px;
            text-align: center;
            border: 2px outset #ece9d8;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            font-family: 'Tahoma', sans-serif;
        }
        
        .stat-label {
            font-size: 10px;
            color: #000;
            text-transform: uppercase;
            margin-top: 2px;
            font-family: 'Tahoma', sans-serif;
        }
        
        .analysis-metadata {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            padding: 8px;
            margin-bottom: 8px;
            border: 2px inset #ece9d8;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .metadata-item {
            text-align: center;
        }
        
        .metadata-value {
            font-weight: bold;
            color: #1565c0;
        }
        
        .metadata-label {
            font-size: 12px;
            color: #1976d2;
        }
        
        /* Windows XP scrollbar styling */
        ::-webkit-scrollbar {
            width: 16px;
            height: 16px;
        }
        
        ::-webkit-scrollbar-track {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            border: 1px inset #ece9d8;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            border: 1px outset #ece9d8;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #f2efde 0%, #ece8d9 50%, #ddd9ca 51%, #d1cdbf 100%);
        }
        
        ::-webkit-scrollbar-button {
            background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%);
            border: 1px outset #ece9d8;
            width: 16px;
            height: 16px;
        }
        
        ::-webkit-scrollbar-button:hover {
            background: linear-gradient(to bottom, #f2efde 0%, #ece8d9 50%, #ddd9ca 51%, #d1cdbf 100%);
        }
        
        /* Windows XP focus styling */
        input:focus, button:focus, select:focus {
            outline: 1px dotted #000;
            outline-offset: -2px;
        }
        
        /* Loading and progress styling */
        .loading {
            text-align: center;
            padding: 20px;
            color: #000;
            font-family: 'Tahoma', sans-serif;
            font-size: 11px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ffffff;
            border: 2px inset #ece9d8;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4b91d9 0%, #207dca 50%, #1941a5 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <div class="site-title">AEP Dynamic Grid Challenge - N-1 Contingency Analysis</div>
            <div class="site-desc">Comprehensive transmission line outage analysis for Hawaii 40-Bus System</div>
        </div>
        <nav class="site-nav" aria-label="Main navigation">
            <a href="/">Main Dashboard</a>
            <a href="/n1" class="active">N-1 Analysis</a>
        </nav>
    </div>
    
    <div class="container">
        <div class="controls">
            <div style="background: linear-gradient(to bottom, #ece9d8 0%, #e6e2d3 50%, #d8d4c5 51%, #ccc8b9 100%); padding: 8px; border: 2px inset #ece9d8; margin-bottom: 8px; box-shadow: 1px 1px 2px rgba(0,0,0,0.2);">
                <h4 style="color: #000; margin-bottom: 4px; text-align: center; font-family: 'Tahoma', sans-serif; font-size: 12px; font-weight: bold;">N-1 Analysis Conditions</h4>
                <p style="color: #000; font-size: 11px; text-align: center; margin-bottom: 8px; font-family: 'Tahoma', sans-serif;">
                    <strong>Test grid stability by removing transmission lines one at a time</strong>
                </p>
                <div class="control-group">
                    <div class="control-item">
                        <label for="temperature">Temperature (°C)</label>
                        <input type="number" id="temperature" value="35" min="20" max="70" oninput="updateFahrenheit()">
                        <div id="fahrenheit" style="font-size: 10px; color: #000; margin-top: 1px; font-family: 'Tahoma', sans-serif;">95°F</div>
                    </div>
                    <div class="control-item">
                        <label for="windSpeed">Wind Speed (ft/sec)</label>
                        <input type="number" id="windSpeed" value="2.0" min="0.1" max="10" step="0.1" oninput="updateMph()">
                        <div id="mph" style="font-size: 12px; color: #666; margin-top: 2px;">1.4 mph</div>
                    </div>
                    <div class="control-item">
                        <label for="maxLines">Lines to Test</label>
                        <select id="maxLines">
                            <option value="10">First 10 Lines</option>
                            <option value="20">First 20 Lines</option>
                            <option value="30">First 30 Lines</option>
                            <option value="">All Lines</option>
                        </select>
                    </div>
                    <button class="analyze-btn" onclick="runN1Analysis()">Run N-1 Analysis</button>
                    <button class="analyze-btn" id="aiSummaryBtnN1" onclick="generateAISummary('n1')">AI N-1 Analysis</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>N-1 Analysis Summary</h3>
            <div id="summary" class="loading">
                Click "Run N-1 Analysis" to start contingency testing...
            </div>
        </div>

        <div class="card" id="aiSummarySection" style="display: none;">
            <h3>AI N-1 Contingency Analysis</h3>
            <div id="aiSummaryResults" class="loading">
                <div class="ai-summary-content"></div>
            </div>
            <div id="progressContainer" style="display: none;">
                <p style="margin-bottom: 10px;">Analysis Progress:</p>
                <div class="progress-bar">
                    <div id="progressBar" class="progress-fill" style="width: 0%;"></div>
                </div>
                <p id="progressText" style="text-align: center; margin-top: 5px;">Starting analysis...</p>
            </div>
        </div>
        
        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('violations')">Violations</div>
                <div class="tab" onclick="switchTab('contingencies')">Contingencies</div>
                <div class="tab" onclick="switchTab('statistics')">Statistics</div>
                <div class="tab" onclick="switchTab('chart')">Analysis Chart</div>
            </div>
            
            <div id="violations" class="tab-content active">
                <h3>Post-Contingency Violations</h3>
                <div class="filter-controls">
                    <div class="filter-item">
                        <label>Min Loading (%)</label>
                        <input type="number" id="minLoadingFilter" value="80" min="0" max="200" onchange="filterViolations()">
                    </div>
                    <div class="filter-item">
                        <label>Severity</label>
                        <select id="severityFilter" onchange="filterViolations()">
                            <option value="">All Severities</option>
                            <option value="overloaded">Overloaded (≥100%)</option>
                            <option value="critical">Critical (90-99%)</option>
                            <option value="caution">Caution (60-89%)</option>
                            <option value="normal">Normal (<60%)</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Conductor Type</label>
                        <select id="conductorFilter" onchange="filterViolations()">
                            <option value="">All Conductors</option>
                        </select>
                    </div>
                    <button class="export-btn" onclick="exportViolations()">Export CSV</button>
                </div>
                <div id="violationsTable" class="loading">
                    Run analysis to see violations...
                </div>
            </div>
            
            <div id="contingencies" class="tab-content">
                <h3>Contingency Results</h3>
                <div class="filter-controls">
                    <div class="filter-item">
                        <label>Min Violations</label>
                        <input type="number" id="minViolationsFilter" value="0" min="0" onchange="filterContingencies()">
                    </div>
                    <div class="filter-item">
                        <label>Status</label>
                        <select id="statusFilter" onchange="filterContingencies()">
                            <option value="">All Status</option>
                            <option value="OVERLOADED">Overloaded Only</option>
                            <option value="CRITICAL">Critical Only</option>
                            <option value="CAUTION">Caution Only</option>
                            <option value="NORMAL">Normal Only</option>
                        </select>
                    </div>
                    <button class="export-btn" onclick="exportContingencies()">Export CSV</button>
                </div>
                <div id="contingenciesTable" class="loading">
                    Run analysis to see contingency results...
                </div>
            </div>
            
            <div id="statistics" class="tab-content">
                <h3>Analysis Statistics</h3>
                <div id="statisticsContent" class="loading">
                    Run analysis to see detailed statistics...
                </div>
            </div>
            
            <div id="chart" class="tab-content">
                <h3>N-1 Analysis Visualization</h3>
                <div class="chart-container">
                    <canvas id="n1Chart"></canvas>
                </div>
            </div>
        </div>
        

    </div>

    <script>
        let n1Chart = null;
        let currentResults = null;
        let filteredViolations = [];
        let filteredContingencies = [];
        
        async function runN1Analysis() {
            const temp = document.getElementById('temperature').value;
            const wind = document.getElementById('windSpeed').value;
            const maxLines = document.getElementById('maxLines').value;
            
            // Show loading states
            document.getElementById('summary').innerHTML = '<div class="loading">Running N-1 contingency analysis...</div>';
            document.getElementById('violationsTable').innerHTML = '<div class="loading">Analyzing contingencies...</div>';
            document.getElementById('contingenciesTable').innerHTML = '<div class="loading">Processing results...</div>';
            
            // Show progress bar
            document.getElementById('progressContainer').style.display = 'block';
            simulateProgress();
            
            try {
                let url = `/api/n1_analysis?temp=${temp}&wind=${wind}`;
                if (maxLines) {
                    url += `&max_lines=${maxLines}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                currentResults = data;
                
                // Hide progress bar
                document.getElementById('progressContainer').style.display = 'none';
                
                if (data.error) {
                    document.getElementById('summary').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #f44336;">
                            <h4>Analysis Error</h4>
                            <p>${data.error}</p>
                        </div>
                    `;
                    return;
                }
                
                displaySummary(data.summary, temp, wind);
                displayViolations(data.violations);
                displayContingencies(data.contingency_results);
                displayStatistics(data);
                updateChart(data);
                populateFilterOptions(data);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('summary').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #f44336;">
                        <h4>Analysis Failed</h4>
                        <p>Unable to complete N-1 analysis</p>
                    </div>
                `;
            }
        }
        
        function simulateProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 95) progress = 95;
                
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `Analyzing contingencies... ${Math.round(progress)}%`;
                
                if (progress >= 95) {
                    clearInterval(interval);
                }
            }, 500);
        }
        
        function displaySummary(summary, temp, wind) {
            const systemStatus = summary.critical_contingencies > 0 ? 'CRITICAL' : 'NORMAL';
            const statusClass = systemStatus.toLowerCase();
            
            document.getElementById('summary').innerHTML = `
                <div class="summary-grid">
                    <div class="summary-item ${statusClass}">
                        <span class="number">${systemStatus}</span>
                        <span class="label">System Security</span>
                    </div>
                    <div class="summary-item critical">
                        <span class="number">${summary.critical_contingencies}</span>
                        <span class="label">Critical Contingencies</span>
                    </div>
                    <div class="summary-item">
                        <span class="number">${summary.total_violations}</span>
                        <span class="label">Total Violations</span>
                    </div>
                    <div class="summary-item">
                        <span class="number">${summary.total_contingencies}</span>
                        <span class="label">Contingencies Tested</span>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                    Analysis Conditions: ${temp}°C, ${wind} ft/sec wind
                </p>
            `;
        }
        
        function getSeverity(loading) {
            if (loading >= 100) return 'overloaded';
            if (loading >= 90) return 'critical';
            if (loading >= 60) return 'caution';
            return 'normal';
        }
        
        function getSeverityColor(severity) {
            const colors = {
                'overloaded': '#d32f2f',
                'critical': '#f44336',
                'caution': '#ff9800',
                'normal': '#4caf50'
            };
            return colors[severity] || '#666';
        }
        
        function displayViolations(violations) {
            filteredViolations = violations;
            
            if (violations.length === 0) {
                document.getElementById('violationsTable').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #4caf50;">
                            <h4>No Violations Found</h4>
                            <p>All contingencies passed - system is N-1 secure under these conditions</p>
                        </div>
                `;
                return;
            }
            
            renderViolationsTable(violations);
        }
        
        function renderViolationsTable(violations) {
            const tableHtml = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Severity</th>
                                <th>Contingency (Outaged Line)</th>
                                <th>Overloaded Line</th>
                                <th>Loading</th>
                                <th>Flow (MW)</th>
                                <th>Rating (MVA)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${violations.slice(0, 100).map((violation, index) => {
                                const severity = getSeverity(violation.loading_pct);
                                const severityColor = getSeverityColor(severity);
                                return `
                                    <tr class="expandable-row" onclick="toggleViolationDetails(${index})" style="${violation.loading_pct > 100 ? 'background-color: #f5f5f5;' : ''}">
                                        <td style="text-align: center; font-weight: bold; color: #666;">
                                            #${index + 1}
                                        </td>
                                        <td>
                                            <span class="severity-indicator severity-${severity}" style="background: ${severityColor};"></span>
                                            ${severity.toUpperCase()}
                                        </td>
                                        <td title="${violation.contingency_name}">
                                            ${violation.contingency_name.substring(0, 25)}${violation.contingency_name.length > 25 ? '...' : ''}
                                        </td>
                                        <td title="${violation.overloaded_line_name}">
                                            ${violation.overloaded_line_name.substring(0, 25)}${violation.overloaded_line_name.length > 25 ? '...' : ''}
                                        </td>
                                        <td style="font-weight: bold; color: ${severityColor};">
                                            ${violation.loading_pct.toFixed(1)}%
                                        </td>
                                        <td>${violation.flow.toFixed(1)}</td>
                                        <td>${violation.rating.toFixed(1)}</td>
                                        <td style="text-align: center;">
                                            <span style="cursor: pointer; color: #667eea;">Details</span>
                                        </td>
                                    </tr>
                                    <tr id="details-${index}" class="details-row">
                                        <td colspan="8">
                                            <div class="details-content">
                                                <strong>Detailed Information:</strong><br>
                                                <strong>Contingency:</strong> ${violation.contingency_name}<br>
                                                <strong>Overloaded Line:</strong> ${violation.overloaded_line_name}<br>
                                                <strong>Loading:</strong> ${violation.loading_pct.toFixed(2)}% (${(violation.loading_pct - 100).toFixed(1)}% over limit)<br>
                                                <strong>Power Flow:</strong> ${violation.flow.toFixed(2)} MW<br>
                                                <strong>Line Rating:</strong> ${violation.rating.toFixed(2)} MVA<br>
                                                <strong>Severity:</strong> ${severity.toUpperCase()} - ${getSeverityDescription(severity)}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 10px; color: #7f8c8d; font-size: 14px;">
                    Showing ${Math.min(100, violations.length)} of ${violations.length} violations (sorted by loading %)
                </p>
            `;
            
            document.getElementById('violationsTable').innerHTML = tableHtml;
        }
        
        function getSeverityDescription(severity) {
            const descriptions = {
                'overloaded': 'Thermal limit exceeded - immediate action required',
                'critical': 'Approaching thermal limit - critical condition',
                'caution': 'Elevated loading - requires monitoring',
                'normal': 'Normal operating range'
            };
            return descriptions[severity] || '';
        }
        
        function toggleViolationDetails(index) {
            const detailsRow = document.getElementById(`details-${index}`);
            if (detailsRow.style.display === 'table-row') {
                detailsRow.style.display = 'none';
            } else {
                detailsRow.style.display = 'table-row';
            }
        }
        
        function displayContingencies(contingencies) {
            filteredContingencies = contingencies;
            renderContingenciesTable(contingencies);
        }
        
        function renderContingenciesTable(contingencies) {
            const tableHtml = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Contingency Line</th>
                                <th>Violations</th>
                                <th>Max Loading</th>
                                <th>Status</th>
                                <th>Risk Level</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${contingencies.slice(0, 100).map((cont, index) => {
                                const riskLevel = getRiskLevel(cont.violation_count, cont.max_loading);
                                const riskColor = getRiskColor(riskLevel);
                                return `
                                    <tr class="expandable-row" onclick="toggleContingencyDetails(${index})">
                                        <td style="text-align: center; font-weight: bold; color: #666;">
                                            #${index + 1}
                                        </td>
                                        <td title="${cont.contingency_name}">
                                            ${cont.contingency_name.substring(0, 35)}${cont.contingency_name.length > 35 ? '...' : ''}
                                        </td>
                                        <td style="text-align: center; font-weight: bold; color: ${cont.violation_count > 0 ? '#f44336' : '#4caf50'};">
                                            ${cont.violation_count}
                                        </td>
                                        <td style="font-weight: bold; color: ${cont.max_loading > 100 ? '#f44336' : '#666'};">
                                            ${cont.max_loading.toFixed(1)}%
                                        </td>
                                        <td><span class="status-badge status-${cont.status.toLowerCase()}">${cont.status}</span></td>
                                        <td>
                                            <span class="severity-indicator" style="background: ${riskColor};"></span>
                                            ${riskLevel.toUpperCase()}
                                        </td>
                                        <td style="text-align: center;">
                                            <span style="cursor: pointer; color: #667eea;">Details</span>
                                        </td>
                                    </tr>
                                    <tr id="cont-details-${index}" class="details-row">
                                        <td colspan="7">
                                            <div class="details-content">
                                                <strong>Contingency Analysis:</strong><br>
                                                <strong>Outaged Line:</strong> ${cont.contingency_name}<br>
                                                <strong>Violations Count:</strong> ${cont.violation_count}<br>
                                                <strong>Maximum Loading:</strong> ${cont.max_loading.toFixed(2)}%<br>
                                                <strong>Status:</strong> ${cont.status}<br>
                                                <strong>Risk Assessment:</strong> ${riskLevel.toUpperCase()} - ${getRiskDescription(riskLevel)}<br>
                                                ${cont.error ? `<strong>Error:</strong> ${cont.error}<br>` : ''}
                                                <strong>Impact:</strong> ${getImpactDescription(cont.violation_count, cont.max_loading)}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 10px; color: #7f8c8d; font-size: 14px;">
                    Showing ${Math.min(100, contingencies.length)} of ${contingencies.length} contingencies (sorted by violation count)
                </p>
            `;
            
            document.getElementById('contingenciesTable').innerHTML = tableHtml;
        }
        
        function getRiskLevel(violationCount, maxLoading) {
            if (violationCount >= 5 || maxLoading > 150) return 'critical';
            if (violationCount >= 3 || maxLoading > 120) return 'high';
            if (violationCount >= 1 || maxLoading > 100) return 'medium';
            return 'low';
        }
        
        function getRiskColor(riskLevel) {
            const colors = {
                'critical': '#f44336',
                'high': '#ff9800',
                'medium': '#ffeb3b',
                'low': '#4caf50'
            };
            return colors[riskLevel] || '#666';
        }
        
        function getRiskDescription(riskLevel) {
            const descriptions = {
                'critical': 'High system impact - multiple severe violations',
                'high': 'Significant impact - multiple violations',
                'medium': 'Moderate impact - some violations',
                'low': 'Low impact - minimal or no violations'
            };
            return descriptions[riskLevel] || '';
        }
        
        function getImpactDescription(violationCount, maxLoading) {
            if (violationCount === 0) return 'No system impact - contingency is secure';
            if (violationCount === 1) return 'Single line overload - localized impact';
            if (violationCount <= 3) return 'Multiple line overloads - regional impact';
            return 'Widespread overloads - system-wide impact';
        }
        
        function toggleContingencyDetails(index) {
            const detailsRow = document.getElementById(`cont-details-${index}`);
            if (detailsRow.style.display === 'table-row') {
                detailsRow.style.display = 'none';
            } else {
                detailsRow.style.display = 'table-row';
            }
        }
        
        function updateChart(data) {
            const ctx = document.getElementById('n1Chart').getContext('2d');
            
            if (n1Chart) {
                n1Chart.destroy();
            }
            
            // Prepare data for chart
            const contingencies = data.contingency_results.slice(0, 20); // Top 20 contingencies
            const labels = contingencies.map(c => {
                // Extract line number from contingency name (e.g., "L40" from longer name)
                const name = c.contingency_name;
                const lineMatch = name.match(/L\d+/i) || name.match(/LINE\s*(\d+)/i);
                if (lineMatch) {
                    return lineMatch[0].toUpperCase();
                }
                // Fallback: use first part before space or dash
                const parts = name.split(/[\s\-_]/);
                return parts[0].substring(0, 6);
            });
            const violationCounts = contingencies.map(c => c.violation_count);
            const maxLoadings = contingencies.map(c => c.max_loading);
            
            n1Chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Violation Count',
                            data: violationCounts,
                            backgroundColor: violationCounts.map(v => v > 0 ? '#f44336' : '#4caf50'),
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'Max Loading (%)',
                            data: maxLoadings,
                            type: 'line',
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#667eea',
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: 20
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Contingency (Outaged Line)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Number of Violations',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Max Loading (%)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'N-1 Contingency Analysis Results (Top 20 Contingencies)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return contingencies[index].contingency_name;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function populateFilterOptions(data) {
            // Populate conductor filter
            const conductors = [...new Set(data.violations.map(v => v.conductor || 'Unknown'))];
            const conductorSelect = document.getElementById('conductorFilter');
            conductorSelect.innerHTML = '<option value="">All Conductors</option>';
            conductors.forEach(conductor => {
                conductorSelect.innerHTML += `<option value="${conductor}">${conductor}</option>`;
            });
        }
        
        function filterViolations() {
            const minLoading = parseFloat(document.getElementById('minLoadingFilter').value) || 0;
            const severity = document.getElementById('severityFilter').value;
            const conductor = document.getElementById('conductorFilter').value;
            
            let filtered = currentResults.violations.filter(violation => {
                if (violation.loading_pct < minLoading) return false;
                if (severity && getSeverity(violation.loading_pct) !== severity) return false;
                if (conductor && (violation.conductor || 'Unknown') !== conductor) return false;
                return true;
            });
            
            renderViolationsTable(filtered);
        }
        
        function filterContingencies() {
            const minViolations = parseInt(document.getElementById('minViolationsFilter').value) || 0;
            const status = document.getElementById('statusFilter').value;
            
            let filtered = currentResults.contingency_results.filter(cont => {
                if (cont.violation_count < minViolations) return false;
                if (status && cont.status !== status) return false;
                return true;
            });
            
            renderContingenciesTable(filtered);
        }
        
        function displayStatistics(data) {
            const violations = data.violations;
            const contingencies = data.contingency_results;
            
            // Calculate statistics
            const severityStats = {
                overloaded: violations.filter(v => getSeverity(v.loading_pct) === 'overloaded').length,
                critical: violations.filter(v => getSeverity(v.loading_pct) === 'critical').length,
                caution: violations.filter(v => getSeverity(v.loading_pct) === 'caution').length,
                normal: violations.filter(v => getSeverity(v.loading_pct) === 'normal').length
            };
            
            const riskStats = {
                critical: contingencies.filter(c => getRiskLevel(c.violation_count, c.max_loading) === 'critical').length,
                high: contingencies.filter(c => getRiskLevel(c.violation_count, c.max_loading) === 'high').length,
                medium: contingencies.filter(c => getRiskLevel(c.violation_count, c.max_loading) === 'medium').length,
                low: contingencies.filter(c => getRiskLevel(c.violation_count, c.max_loading) === 'low').length
            };
            
            const avgLoading = violations.length > 0 ? violations.reduce((sum, v) => sum + v.loading_pct, 0) / violations.length : 0;
            const maxLoading = violations.length > 0 ? Math.max(...violations.map(v => v.loading_pct)) : 0;
            const avgViolationsPerContingency = contingencies.length > 0 ? contingencies.reduce((sum, c) => sum + c.violation_count, 0) / contingencies.length : 0;
            
            const statisticsHtml = `
                <div class="analysis-metadata">
                    <h4 style="margin-bottom: 15px; text-align: center;">Analysis Metadata</h4>
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <div class="metadata-value">${data.summary.temperature}°C</div>
                            <div class="metadata-label">Temperature</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-value">${data.summary.wind_speed} ft/s</div>
                            <div class="metadata-label">Wind Speed</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-value">${data.summary.total_contingencies}</div>
                            <div class="metadata-label">Lines Tested</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-value">${new Date().toLocaleTimeString()}</div>
                            <div class="metadata-label">Analysis Time</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${avgLoading.toFixed(1)}%</div>
                        <div class="stat-label">Average Violation Loading</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${maxLoading.toFixed(1)}%</div>
                        <div class="stat-label">Maximum Loading</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${avgViolationsPerContingency.toFixed(1)}</div>
                        <div class="stat-label">Avg Violations per Contingency</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${((data.summary.critical_contingencies / data.summary.total_contingencies) * 100).toFixed(1)}%</div>
                        <div class="stat-label">Critical Contingency Rate</div>
                    </div>
                </div>
                
                <h4>Violation Severity Distribution</h4>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left: 4px solid #d32f2f;">
                        <div class="stat-value">${severityStats.overloaded}</div>
                        <div class="stat-label">Overloaded (≥100%)</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #f44336;">
                        <div class="stat-value">${severityStats.critical}</div>
                        <div class="stat-label">Critical (90-99%)</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #ff9800;">
                        <div class="stat-value">${severityStats.caution}</div>
                        <div class="stat-label">Caution (60-89%)</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #4caf50;">
                        <div class="stat-value">${severityStats.normal}</div>
                        <div class="stat-label">Normal (<60%)</div>
                    </div>
                </div>
                
                <h4>Contingency Risk Distribution</h4>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left: 4px solid #f44336;">
                        <div class="stat-value">${riskStats.critical}</div>
                        <div class="stat-label">Critical Risk</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #ff9800;">
                        <div class="stat-value">${riskStats.high}</div>
                        <div class="stat-label">High Risk</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #ffeb3b;">
                        <div class="stat-value">${riskStats.medium}</div>
                        <div class="stat-label">Medium Risk</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #4caf50;">
                        <div class="stat-value">${riskStats.low}</div>
                        <div class="stat-label">Low Risk</div>
                    </div>
                </div>
            `;
            
            document.getElementById('statisticsContent').innerHTML = statisticsHtml;
        }
        
        function exportViolations() {
            if (!currentResults || !currentResults.violations.length) {
                alert('No violation data to export');
                return;
            }
            
            const headers = ['Rank', 'Severity', 'Contingency', 'Overloaded Line', 'Loading %', 'Flow MW', 'Rating MVA'];
            const csvContent = [
                headers.join(','),
                ...currentResults.violations.map((v, i) => [
                    i + 1,
                    getSeverity(v.loading_pct),
                    `"${v.contingency_name}"`,
                    `"${v.overloaded_line_name}"`,
                    v.loading_pct.toFixed(2),
                    v.flow.toFixed(2),
                    v.rating.toFixed(2)
                ].join(','))
            ].join('\n');
            
            downloadCSV(csvContent, 'n1_violations.csv');
        }
        
        function exportContingencies() {
            if (!currentResults || !currentResults.contingency_results.length) {
                alert('No contingency data to export');
                return;
            }
            
            const headers = ['Rank', 'Contingency Line', 'Violations', 'Max Loading %', 'Status', 'Risk Level'];
            const csvContent = [
                headers.join(','),
                ...currentResults.contingency_results.map((c, i) => [
                    i + 1,
                    `"${c.contingency_name}"`,
                    c.violation_count,
                    c.max_loading.toFixed(2),
                    c.status,
                    getRiskLevel(c.violation_count, c.max_loading)
                ].join(','))
            ].join('\n');
            
            downloadCSV(csvContent, 'n1_contingencies.csv');
        }
        
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        // Convert Celsius to Fahrenheit
        function updateFahrenheit() {
            const celsius = document.getElementById('temperature').value;
            const fahrenheit = (celsius * 9/5) + 32;
            document.getElementById('fahrenheit').textContent = fahrenheit.toFixed(0) + '°F';
        }

        // Convert ft/sec to mph
        function updateMph() {
            const ftPerSec = document.getElementById('windSpeed').value;
            const mph = ftPerSec * 0.681818; // 1 ft/sec = 0.681818 mph
            document.getElementById('mph').textContent = mph.toFixed(1) + ' mph';
        }
        
        // Initialize Fahrenheit and mph displays
        document.addEventListener('DOMContentLoaded', function() {
            updateFahrenheit();
            updateMph();
        });

        // AI Summary functionality
        async function generateAISummary(type = 'n1') {
            const summarySection = document.getElementById('aiSummarySection');
            const summaryResults = document.getElementById('aiSummaryResults');
            const summaryBtn = document.getElementById('aiSummaryBtnN1');
            
            // Check if N-1 analysis has been run
            if (type === 'n1' && (typeof currentResults === 'undefined' || !currentResults)) {
                summarySection.style.display = 'block';
                summaryResults.innerHTML = `
                    <div style="color: #ff9800; padding: 15px; background: #fff3e0; border-radius: 4px; border-left: 4px solid #ff9800;">
                        <strong>Please run N-1 Analysis first</strong><br>
                        Click "Run N-1 Analysis" button above to generate contingency data before requesting AI analysis.
                    </div>
                `;
                return;
            }
            
            // Show section and loading state
            summarySection.style.display = 'block';
            summaryResults.innerHTML = '<div class="ai-loading">Generating AI N-1 analysis...</div>';
            summaryBtn.disabled = true;
            summaryBtn.innerHTML = 'Generating...';
            
            try {
                // Prepare request body with N-1 results if available
                const requestBody = { type: type };
                if (type === 'n1' && typeof currentResults !== 'undefined' && currentResults) {
                    requestBody.n1_results = currentResults;
                    console.log('Passing N-1 results to AI:', currentResults.summary);
                }
                
                const response = await fetch('/api/ai-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Format the AI response
                    const formattedSummary = formatAISummary(result.summary);
                    summaryResults.innerHTML = `
                        <div class="ai-summary-content">
                            ${formattedSummary}
                            <div style="margin-top: 15px; padding: 8px; background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4caf50; font-size: 12px; color: #666;">
                                <strong>Generated:</strong> ${new Date(result.timestamp).toLocaleString()}
                            </div>
                        </div>
                    `;
                } else {
                    summaryResults.innerHTML = `
                        <div style="color: #d32f2f; padding: 15px; background: #ffebee; border-radius: 4px;">
                            <strong>Error:</strong> ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                summaryResults.innerHTML = `
                    <div style="color: #d32f2f; padding: 15px; background: #ffebee; border-radius: 4px;">
                        <strong>Error:</strong> Failed to generate AI summary. ${error.message}
                    </div>
                `;
            } finally {
                summaryBtn.disabled = false;
                summaryBtn.innerHTML = 'AI N-1 Analysis';
            }
        }

        function formatAISummary(text) {
            // Convert markdown-like formatting to HTML
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^(\d+\.\s.*$)/gm, '<h4>$1</h4>')
                .replace(/^-\s(.*)$/gm, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrap consecutive list items in ul tags
            formatted = formatted.replace(/(<li>.*?<\/li>)(\s*<li>.*?<\/li>)*/g, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            // Wrap in paragraphs
            if (!formatted.startsWith('<h4>') && !formatted.startsWith('<ul>')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            return formatted;
        }
    </script>
</body>
</html>